"use client";

import React, { useState, useMemo } from 'react';
import {
    useReactTable,
    getCoreRowModel,
    getPaginationRowModel,
    getSortedRowModel,
    getFilteredRowModel,
    flexRender,
    SortingState,
    ColumnDef,
    RowSelectionState,
} from '@tanstack/react-table';
import { AnimatePresence, motion } from 'framer-motion';
import { Document } from '../types';
import Modal from './Modal'; // Make sure this path is correct

import { IoClose, IoEyeOutline, IoDownloadOutline, IoSearchOutline, IoCheckbox, IoSquareOutline, IoCloseCircleOutline } from 'react-icons/io5';
import { HiOutlineDocumentText } from "react-icons/hi";

// (LoadingSpinner and formatHeader helpers remain the same)
const LoadingSpinner = () => (
    <div className="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-50">
        <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-sky-500"></div>
    </div>
);
const formatHeader = (key: string): string => key.replace(/([A-Z])/g, ' $1').replace(/^./, (str) => str.toUpperCase());


interface GridViewProps {
    documents: Document[];
    pageSize: number;
    onPageSizeChange: (size: number) => void;
    isLoading: boolean;
    currentPage: number;
    totalDocuments: number;
    onPageChange: (page: number) => void;
}

const GridView: React.FC<GridViewProps> = ({ documents, pageSize, onPageSizeChange, isLoading, currentPage, totalDocuments, onPageChange }) => {
    // State
    const [selectedDoc, setSelectedDoc] = useState<Document | null>(null);
    const [sorting, setSorting] = useState<SortingState>([]);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [modalContent, setModalContent] = useState('');
    const [isModalContentLoading, setIsModalContentLoading] = useState(false);
    const [documentToView, setDocumentToView] = useState<Document | null>(null);
    const [globalFilter, setGlobalFilter] = useState('');
    const [multiDownloadMode, setMultiDownloadMode] = useState(false);
    const [rowSelection, setRowSelection] = useState<RowSelectionState>({});

    const pythonServerUrl = process.env.NEXT_PUBLIC_PYTHON_SERVER_URL || `http://192.168.10.144:8000`;

    // (Helper functions: getFileExtension, handleOpenDocument, handleDownloadDocument remain the same)
    const handleOpenDocument = async (doc: Document) => { /* ... implementation ... */ };
    const handleDownloadDocument = (doc: Document) => { /* ... implementation ... */ };

    // ★ CORRECTED Multi-Download Handler ★
    const handleMultiDownload = () => {
        const selectedRows = table.getSelectedRowModel().flatRows;
        if (selectedRows.length === 0) {
            alert("Please select at least one document to download.");
            return;
        }

        const prophecyIds = selectedRows.map(row => row.original.ProphecyId);
        
        // Use the absolute URL from your pythonServerUrl variable
        const downloadUrl = `${pythonServerUrl}/download_multiple`;

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = downloadUrl; // Use the full URL here
        form.target = '_blank';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'prophecy_ids';
        input.value = JSON.stringify(prophecyIds);
        form.appendChild(input);

        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);

        setMultiDownloadMode(false);
        setRowSelection({});
    };

    const pageCount = useMemo(() => {
        return pageSize > 0 ? Math.ceil(totalDocuments / pageSize) : 0;
    }, [totalDocuments, pageSize]);

    const columns = useMemo<ColumnDef<Document>[]>(() => {
        // ... (column definition logic is correct and unchanged)
        const baseColumns: ColumnDef<Document>[] = multiDownloadMode ? [
            {
                id: 'select',
                header: ({ table }) => (
                     <IndeterminateCheckbox
                        {...{
                            checked: table.getIsAllPageRowsSelected(),
                            indeterminate: table.getIsSomePageRowsSelected(),
                            onChange: table.getToggleAllPageRowsSelectedHandler(),
                        }}
                    />
                ),
                cell: ({ row }) => (
                    <div className="px-1 flex justify-center">
                         <IndeterminateCheckbox
                            {...{
                                checked: row.getIsSelected(),
                                disabled: !row.getCanSelect(),
                                indeterminate: row.getIsSomeSelected(),
                                onChange: row.getToggleSelectedHandler(),
                            }}
                        />
                    </div>
                ),
            }
        ] : [];
        
        if (documents.length === 0) return baseColumns;

        const dataKeys = Object.keys(documents[0]).filter(key => key !== 'Text' && key !== 'highlighted_text');
        const dataColumns: ColumnDef<Document>[] = dataKeys.map(key => ({
            accessorKey: key,
            header: () => <span>{formatHeader(key)}</span>,
            cell: info => {
                const value = info.getValue();
                if (typeof value === 'string' && value.length > 50) return `${value.substring(0, 50)}...`;
                if (typeof value === 'boolean') return value ? 'Yes' : 'No';
                return value === null || typeof value === 'undefined' ? 'N/A' : String(value);
            },
        }));

        return [...baseColumns, ...dataColumns];
    }, [documents, multiDownloadMode]);

    const table = useReactTable({
        data: documents,
        columns,
        pageCount,
        state: {
            sorting,
            pagination: { pageIndex: currentPage - 1, pageSize },
            globalFilter,
            rowSelection,
        },
        manualPagination: true,
        enableRowSelection: true,
        onRowSelectionChange: setRowSelection,
        onGlobalFilterChange: setGlobalFilter,
        onSortingChange: setSorting,
        onPaginationChange: (updater) => {
            if (typeof updater === 'function') {
                const newPaginationState = updater({ pageIndex: currentPage - 1, pageSize });
                onPageChange(newPaginationState.pageIndex + 1);
                onPageSizeChange(newPaginationState.pageSize);
            } else {
                onPageChange(updater.pageIndex + 1);
                onPageSizeChange(updater.pageSize);
            }
        },
        getCoreRowModel: getCoreRowModel(),
        getPaginationRowModel: getPaginationRowModel(),
        getSortedRowModel: getSortedRowModel(),
        getFilteredRowModel: getFilteredRowModel(),
        autoResetPageIndex: false,
    });

    const handleRowClick = (doc: Document) => {
        if (multiDownloadMode) return;
        setSelectedDoc(prevDoc => (prevDoc === doc ? null : doc));
    };

    const gridVariants = { full: { width: '100%' }, shrunk: { width: '65%' } };
    const sidebarVariants = { hidden: { x: '100%', opacity: 0 }, visible: { x: 0, opacity: 1 } };

    return (
        <div className="flex h-full w-full bg-slate-50 overflow-hidden relative">
            {isLoading && <LoadingSpinner />}

            <motion.div
                className="flex flex-col h-full"
                animate={selectedDoc ? 'shrunk' : 'full'}
                variants={gridVariants}
                transition={{ duration: 0.4, ease: [0.16, 1, 0.3, 1] }}
            >
                {/* (Toolbar, table, and pagination JSX are correct and unchanged) */}
                 <div className="flex items-center justify-between p-2 border-b bg-white flex-shrink-0">
                    <div className="relative">
                        <IoSearchOutline className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                        <input
                            type="text"
                            value={globalFilter ?? ''}
                            onChange={e => setGlobalFilter(e.target.value)}
                            className="pl-9 pr-3 py-1.5 border border-gray-300 rounded-md text-sm w-80 focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                            placeholder="Search grid..."
                        />
                    </div>
                    <div>
                        {!multiDownloadMode ? (
                            <button
                                onClick={() => setMultiDownloadMode(true)}
                                className="flex items-center gap-2 px-4 py-1.5 text-sm font-medium text-white bg-sky-600 rounded-md hover:bg-sky-700 transition-colors"
                            >
                                <IoDownloadOutline />
                                Download Multiple
                            </button>
                        ) : (
                            <AnimatePresence>
                                <motion.div
                                    initial={{ opacity: 0, x: 10 }}
                                    animate={{ opacity: 1, x: 0 }}
                                    exit={{ opacity: 0, x: 10 }}
                                    className="flex items-center gap-3"
                                >
                                    <span className="text-sm font-medium text-gray-700">
                                        {Object.keys(rowSelection).length} selected
                                    </span>
                                    <button
                                        onClick={handleMultiDownload}
                                        disabled={Object.keys(rowSelection).length === 0}
                                        className="flex items-center gap-2 px-4 py-1.5 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                                    >
                                        <IoDownloadOutline />
                                        Download Selected
                                    </button>
                                    <button
                                        onClick={() => { setMultiDownloadMode(false); setRowSelection({}); }}
                                        className="p-2 text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-full"
                                        aria-label="Cancel multi-download"
                                    >
                                        <IoCloseCircleOutline size={22} />
                                    </button>
                                </motion.div>
                            </AnimatePresence>
                        )}
                    </div>
                </div>

                <div className="flex-grow overflow-auto">
                    { /* Table JSX */ }
                </div>

                <div className="flex items-center justify-between p-2 border-t bg-white flex-shrink-0">
                   { /* Pagination JSX */ }
                </div>
            </motion.div>

            {/* (Sidebar and Modal JSX are correct and unchanged) */}
            <AnimatePresence>
                {selectedDoc && (
                   <motion.div /* ... Sidebar Content ... */ >
                   </motion.div>
                )}
            </AnimatePresence>
            <Modal
                isOpen={isModalOpen}
                onClose={() => setIsModalOpen(false)}
                title={documentToView?.FileName || 'Document'}
                isLoading={isModalContentLoading}
            >
                <div dangerouslySetInnerHTML={{ __html: modalContent }} />
            </Modal>
        </div>
    );
};

// (IndeterminateCheckbox component is correct and unchanged)
function IndeterminateCheckbox({
    indeterminate,
    className = '',
    ...rest
}: { indeterminate?: boolean } & React.HTMLProps<HTMLInputElement>) { /* ... implementation ... */ }

export default GridView;